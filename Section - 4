ğŸ’¼ SECTION 4 â€” CASE STUDY STYLE (INTERVIEW SCENARIOS)
Scenario: E-commerce Tables

Tables:
customers(customer_id, name, city, signup_date)
orders(order_id, customer_id, order_date, amount, payment_type)
products(product_id, category, price)
order_items(order_id, product_id, quantity)

Payment Insights
1. Find which payment type generates the highest total revenue.
1. select payment_type, sum(amount) as total_rev from orders group by payment_type order by sum(amount) desc limit 1

Category Profitability
2. Calculate the total revenue per category and the average order value per category.
2. select products.category, SUM(oi.quantity * oi.unit_price) AS total_revenue,
  AVG(oi.quantity * oi.unit_price) AS avg_order_value
from orders join order_items
join products on
products.product_id = order_items.product_id
group by products.category
order by total_revenue desc

# One subtle note:

If your orders.amount represents the entire orderâ€™s total (not per item),
then joining with order_items could duplicate rows (because an order may appear multiple times â€” once per item).
That would inflate your totals.

So, to avoid double-counting, youâ€™d either:

aggregate from the order_items table itself (summing quantity * price_per_unit), or

use DISTINCT order_id before joining.

High-Value Days
3. Find days when total sales exceeded the monthly average.
3. with cte1 as (select order_date, month(order_date) as mn, sum(amount) as total_sales from orders group by date(order_date), month(order_date)),
cte2 as (select mn, avg(total_sales) as avg_sales from cte1 group by mn)
select cte1.order_date, cte1.tota_sales, cte2.avg_sales from cte1 join cte2 on cte1.mn = cte2.mn
where cte1.total_sales > cte2.avg_sales

Customer Order Frequency
4. Compute average number of orders per customer per month.
4. with cte1 as (select customer_id, month(order_date) as mn, count(order_id) as cnt from orders
group by customer_id, month(order_date))
select cte1.customer_id,  avg(cte1.cnt) as avg_cnt from cte1 group by cte1.customer_id
order by avg_cnt desc

Cross-Selling Potential
5. Identify product pairs that are most frequently bought together (you can do this by self-joining order_items on order_id).
5. with cte1 as (select o1.product_id as prod1, o2.product_id as prod2 from order_items o1 join order_items o2
on o1.order_id = o2.order_id)
select cte1.prod1, cte1.prod2, count(*) as frequency from cte1 
group by cte1.prod1, cte1.prod2
order by count(*) desc

Bonus
If you write:

SELECT payment_type, MAX(amount)
FROM orders
GROUP BY payment_type;


This gives the maximum single order amount per payment type,
not the total revenue from that payment type.

So for example ğŸ‘‡

payment_type	amount
Credit Card	3000
Credit Card	2500
UPI	7000
UPI	2000

MAX(amount) per payment type â†’

payment_type	max_amount
Credit Card	3000
UPI	7000

Thatâ€™s not the total revenue (which would be 5500 and 9000 respectively).

âœ… Correct logic (conceptually, not full query)

First, compute total revenue per payment type:
â†’ SUM(amount) GROUP BY payment_type

Then, either:

Sort by total revenue (ORDER BY total_revenue DESC LIMIT 1)

Or find the MAX(SUM(amount)) using a window function.

ğŸ” Key insight:

MAX() looks at individual rows,
while SUM() ... GROUP BY aggregates rows into groups.

So your thought:

â€œI have to first sum and then rank/sortâ€
is exactly right ğŸ‘
